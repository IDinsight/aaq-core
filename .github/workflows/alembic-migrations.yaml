name: Alembic Migration Check

on:
  pull_request:
    branches:
      - tonyzhao6-main
    paths:
      - "core_backend/migrations/versions/**.py"
      - ".github/workflows/alembic-migrations.yaml"

jobs:
  alembic-check:
    runs-on: ubuntu-20.04

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install alembic package
        run: |
          grep -w 'alembic' core_backend/requirements.txt | xargs python -m pip install

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: tonyzhao6-main

      - name: Get Alembic head of tonyzhao6-main branch
        run: |
          cd core_backend
          alembic_head_main=$(alembic heads | awk '{print $1}')
          echo "ALEMBIC_HEAD_MAIN=${alembic_head_main}" >> $GITHUB_ENV

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Check if Alembic head revision from main exists in feature branch
        run: |
          if alembic history | grep -q ALEMBIC_HEAD_MAIN; then
            echo "Alembic head revision from main exists in this branch."
          else
            echo "Alembic head revision from main does NOT exist in this branch."
            exit 1
          fi
